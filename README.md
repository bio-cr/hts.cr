# htslib.cr

[![CI](https://github.com/bio-crystal/htslib.cr/actions/workflows/ci.yml/badge.svg)](https://github.com/bio-crystal/htslib.cr/actions/workflows/ci.yml)
[![Slack](http://img.shields.io/badge/slack-bio--crystal-purple?labelColor=000000&logo=slack)](https://bio-crystal.slack.com/)
[![Get invite to BioCrystal Slack](http://img.shields.io/badge/Get_invite_to_BioCrystal_Slack-purple?labelColor=000000&logo=slack)](https://join.slack.com/t/bio-crystal/shared_invite/zt-tas46pww-JSEloonmn3Ma5eD2~VeT_g)

htslib.cr is the Crystal bindings to HTSlib, a C library for processing high throughput sequencing (HTS) data. 
It will provide APIs to read and write file formats such as [SAM, BAM, VCF, and BCF](http://samtools.github.io/hts-specs/).

:fire: Feel free to fork it out if you can develop it! 

:hatching_chick: alpha stage.

## Requirements

* [Crystal](https://crystal-lang.org)
* [HTSlib](https://github.com/samtools/htslib)
  * Ubuntu : `apt install libhts-dev`
  * macOS : `brew install htslib`
  * Build from source code

Make sure that `pkg-config` can detect htslib.

```sh
pkg-config --libs htslib
````

### Installation

Add htslib to your `shard.yml`:

   ```yaml
   dependencies:
     htslib:
       github: bio-crystal/htslib.cr
   ```

Run `shards install`

## Usage

SAM / BAM

```crystal
require "htslib/hts/bam"

bam = HTS::Bam.new(bam_path)

bam.each do |r|
  p name:  r.qname,
    flag:  r.flag.value,
    pos:   r.start + 1,
    mpos:  r.mate_start + 1,
    mqual: r.mapping_quality,
    seq:   r.sequence,
    cigar: r.cigar,
    qual:  r.base_qualities.map { |i| (i + 33).chr }.join
end

bam.close
```

VCF / BCF

```crystal
require "htslib/hts/bcf"

bcf = HTS::Bcf.new(bcf_path)

bcf.each do |r|
  p start:  r.start,
    stop:   r.stop,
    id:     r.id,
    qual:   r.qual,
    filter: r.filter,
    ref:    r.ref,
    alt:    r.alt
end

bcf.close
```

## API Overview (Plan)

* High level API - Create as needed. But don't overdo it.
* Low level API - Native C bindings to HTSLib generated by [crystal_lib](https://github.com/crystal-lang/crystal_lib).

```
    ┌───────────────────────────────────────────────────────────────┐
    │                              HTS                              │
    │   ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
    │   │ SAM/BAM     │ VCF/BCF     │ CRAM        │ Tabix       │   │
    │   ├─────────────┴─────────────┴─────────────┴─────────────┤   │
    │   │ LibHTS                                                │   │
    │   │   Native C bindings                                   │   │
    │   │ LibHTS2 : macro functions                             │   │
    │   └───────────────────────────────────────────────────────┘   │
    └───────────────────────────────────────────────────────────────┘
```


## Related Work

* [ruby-htslib](https://github.com/kojix2/ruby-htslib)

## Contributing

htslib.cr is an immature, work-in-progress library, and pull requests such as small typo fixes are welcome.

    Do you need commit rights to my repository?
    Do you want to get admin rights and take over the project?
    If so, please feel free to contact us @kojix2.
